<!DOCTYPE html>
<html>
<head>
    <title>Check Current User</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .box { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #5568d3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="box">
        <h1>üîç Check Current User & Nudges</h1>
        <button onclick="checkAuth()">Check Who I Am</button>
        <button onclick="fetchNudgesRaw()">Fetch My Nudges (Raw)</button>
        <button onclick="checkAllUsers()">Check All Users in DB</button>
        <div id="result"></div>
    </div>

    <script>
        const API = 'http://localhost:8080/api';
        
        function getToken() {
            return localStorage.getItem('accessToken');
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        async function checkAuth() {
            const result = document.getElementById('result');
            const token = getToken();
            
            if (!token) {
                result.innerHTML = '<h2 style="color:red">‚ùå Not logged in</h2><p>No token found in localStorage</p>';
                return;
            }

            const payload = parseJwt(token);
            if (!payload) {
                result.innerHTML = '<h2 style="color:red">‚ùå Invalid token</h2>';
                return;
            }

            result.innerHTML = `
                <h2 style="color:green">‚úÖ Logged in!</h2>
                <pre>${JSON.stringify(payload, null, 2)}</pre>
                <p><strong>User ID:</strong> ${payload.sub || 'Unknown'}</p>
                <p><strong>Email:</strong> ${payload.email || 'Unknown'}</p>
                <p><strong>Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</p>
            `;
        }

        async function fetchNudgesRaw() {
            const result = document.getElementById('result');
            const token = getToken();
            
            if (!token) {
                result.innerHTML = '<h2 style="color:red">‚ùå Not logged in</h2>';
                return;
            }

            try {
                const res = await fetch(`${API}/nudges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    result.innerHTML = `<h2 style="color:red">‚ùå Error ${res.status}</h2><pre>${await res.text()}</pre>`;
                    return;
                }

                const nudges = await res.json();
                result.innerHTML = `
                    <h2 style="color:green">‚úÖ Found ${nudges.length} nudges</h2>
                    <pre>${JSON.stringify(nudges, null, 2)}</pre>
                `;
            } catch (e) {
                result.innerHTML = `<h2 style="color:red">‚ùå Error</h2><pre>${e.message}</pre>`;
            }
        }

        async function checkAllUsers() {
            const result = document.getElementById('result');
            result.innerHTML = '<h2>Checking database...</h2><p>Open browser console for SQL queries</p>';
            console.log('Run this in MySQL:');
            console.log('SELECT u.id, u.email, COUNT(n.id) as nudge_count FROM users u LEFT JOIN nudges n ON u.id = n.user_id GROUP BY u.id;');
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
